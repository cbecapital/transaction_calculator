<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Treasury Bill Auction Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #f5f7fb;
      padding: 30px;
      color: #222;
    }
    h1 { text-align: center; color: #004aad; }
    .btn {
      background: #004aad;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
      margin-top: 10px;
    }
    .btn:hover { background: #0066d9; }
    .section {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      max-width: 800px;
      margin: 20px auto;
    }
    label { display: block; margin-top: 10px; font-weight: 600; }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th { background: #f0f0f0; }
    .result-summary {
      background: #f9f9f9;
      padding: 15px;
      margin-top: 20px;
      border-left: 4px solid #004aad;
      border-radius: 6px;
      line-height: 1.6;
    }
    .market-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 20px;
    }
    .chart-container {
      position: relative;
      height: 350px;
      width: 100%;
      margin-top: 25px;
    }
  </style>
</head>
<body>
  <button class="home-btn" onclick="location.href='index.html'">Home</button>
<button class="btn" onclick="location.href='treasury.html'"> Back</button> 

  <h1>ðŸ‡ªðŸ‡¹ Treasury Bill Auction Calculator</h1>

  <div class="market-buttons">
    <button class="btn" onclick="showPrimary()">Primary Market</button>
  </div>

  <div class="section" id="primary-section">
    <h2>Primary Market (Auction Bidding)</h2>
    <p>Estimate how much you must pay today when bidding for Treasury Bills in the National Bank auction.</p>

    <label for="tbillType">Which T-Bill are you bidding for?</label>
    <select id="tbillType">
      <option value="28">28 Days</option>
      <option value="91">91 Days</option>
      <option value="182">182 Days</option>
      <option value="364">364 Days</option>
    </select>

    <label for="quantity">How many T-Bills are you buying?</label>
    <input type="number" id="quantity" placeholder="e.g. 10">

    <label for="yield">Your bid yield (% per year):</label>
    <input type="number" id="yield" placeholder="e.g. 12.5" step="0.01">

    <label for="bidDate">Auction Date:</label>
    <input type="date" id="bidDate">

    <button class="btn" onclick="calculateAuction()">Calculate</button>

    <div id="result"></div>

    <!-- Chart + Table -->
    <div class="chart-container">
      <canvas id="tBillChart"></canvas>
    </div>

    <div id="daily-table-container"></div>
  </div>

  <div class="section" id="secondary-section" style="display:none;">
    <h2>Secondary Market</h2>
    <p>ðŸ’¡ The secondary market calculator is coming soon. Stay tuned!</p>
  </div>

  <script>
    function showPrimary() {
      document.getElementById("primary-section").style.display = "block";
      document.getElementById("secondary-section").style.display = "none";
    }

    function showSecondary() {
      document.getElementById("primary-section").style.display = "none";
      document.getElementById("secondary-section").style.display = "block";
    }

    let chartInstance = null;

    function calculateAuction() {
      const days = parseInt(document.getElementById("tbillType").value);
      const qty = parseInt(document.getElementById("quantity").value);
      const yieldRate = parseFloat(document.getElementById("yield").value);
      const bidDateValue = document.getElementById("bidDate").value;

      if (!days || !qty || !yieldRate || !bidDateValue) {
        alert("Please fill in all fields correctly.");
        return;
      }

      const bidDate = new Date(bidDateValue);
      const maturityDate = new Date(bidDate);
      maturityDate.setDate(bidDate.getDate() + days);

      const faceValuePerTBill = 5000;
      const totalFaceValue = qty * faceValuePerTBill;
      const pricePerTBill = faceValuePerTBill / (1 + (yieldRate / 100) * (days / 365));
      const totalPayment = pricePerTBill * qty;
      const discount = totalFaceValue - totalPayment;

      // Fee
      const feeRate = 0.10; // 0.1%
      const totalFeeAmount = (totalPayment * feeRate) / 100;
      const totalToSend = totalPayment + totalFeeAmount;
      const netProfit = totalFaceValue - totalToSend;

      // --- result summary ---
      const resultHTML = `
        <h3>Calculation Summary</h3>
        <table>
          <tr><th>Description</th><th>Amount / Value</th><th>Notes</th></tr>
          <tr><td>T-Bill Type</td><td>${days} days</td><td>Selected maturity</td></tr>
          <tr><td>Quantity</td><td>${qty}</td><td>Each = 5,000 ETB face value</td></tr>
          <tr><td>Bid Yield</td><td>${yieldRate.toFixed(2)}%</td><td>Annualized</td></tr>
          <tr><td>Total You Pay Today</td><td>${totalPayment.toFixed(2)} ETB</td><td>Before fees</td></tr>
          <tr><td>Total Face Value</td><td>${totalFaceValue.toFixed(2)} ETB</td><td>At maturity</td></tr>
          <tr><td>Gross Profit</td><td>${discount.toFixed(2)} ETB</td><td>Before fees</td></tr>
          <tr><td>Maturity Date</td><td>${maturityDate.toDateString()}</td><td>Expected redemption</td></tr>
          <tr><td>CBE Capital Fee (0.1%)</td><td>${totalFeeAmount.toFixed(2)} ETB</td><td>Commission</td></tr>
          <tr><td><strong>Total to Send</strong></td><td><strong>${totalToSend.toFixed(2)} ETB</strong></td><td>Including fees</td></tr>
          <tr><td><strong>Net Profit</strong></td><td><strong>${netProfit.toFixed(2)} ETB</strong></td><td>After fees</td></tr>
        </table>
      `;
      document.getElementById("result").innerHTML = resultHTML;

      // --- chart + table data ---
      const labels = [];
      const values = [];
      const yields = [];
      const tableRows = [];
      const priceStart = pricePerTBill;
      const priceEnd = faceValuePerTBill;

      for (let d = 0; d <= days; d++) {
        const date = new Date(bidDate);
        date.setDate(bidDate.getDate() + d);
        const dateStr = date.toISOString().slice(0,10);

        const valuePerBill = priceStart + (priceEnd - priceStart) * (d / days);
        const totalVal = valuePerBill * qty;
        const yieldRem = yieldRate * (1 - d / days);

        labels.push(dateStr);
        values.push(totalVal);
        yields.push(yieldRem);

        tableRows.push(`<tr>
          <td>${d}</td>
          <td>${dateStr}</td>
          <td>${totalVal.toFixed(2)}</td>
          <td>${yieldRem.toFixed(2)}%</td>
        </tr>`);
      }

      // --- Chart ---
      const ctx = document.getElementById("tBillChart").getContext("2d");
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Total Value (ETB)",
              data: values,
              borderColor: "#004aad",
              backgroundColor: "rgba(0,74,173,0.1)",
              tension: 0.3,
              fill: true,
              yAxisID: "y",
            },
            {
              label: "Yield Remaining (%)",
              data: yields,
              borderColor: "#f39c12",
              tension: 0.3,
              yAxisID: "y1",
            }
          ]
        },
        options: {
          scales: {
            y: { title: { display: true, text: "Value (ETB)" }, beginAtZero: false },
            y1: { position: "right", title: { display: true, text: "Yield (%)" }, beginAtZero: true }
          },
          plugins: { legend: { position: "top" } }
        }
      });

      // --- Daily Table ---
      document.getElementById("daily-table-container").innerHTML = `
        <h3>ðŸ“Š Daily Breakdown</h3>
        <table>
          <tr><th>Day</th><th>Date</th><th>Total Value (ETB)</th><th>Yield Remaining (%)</th></tr>
          ${tableRows.join("")}
        </table>
      `;
    }
  </script>
</body>
</html>

<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Treasury Bill Auction Calculator</title>

  <link rel="stylesheet" href="treasury.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>


<script>
function formatNumberInput(input) {
  let value = input.value.replace(/,/g, ""); // remove existing commas
  if (!isNaN(value) && value !== "") {
    input.value = Number(value).toLocaleString("en-US");
  }
}
</script>

</head>

<body>
  <video autoplay muted loop id="bg-video">
    <source src="cbe-logo-2.mp4" type="video/mp4">
  </video>

  <button class="home-btn" onclick="location.href='index.html'">Home</button>
  <button class="back-btn" onclick="location.href='treasury.html'">Back</button>

  <div class="container" id="primary-section">
    <div class="section" id="primary-section">
      <h1>Treasury Bill Auction Calculator</h1>

      <h2>Primary Market (Auction Bidding)</h2>
      <p>Estimate how much you must pay today when bidding for Treasury Bills in the National Bank auction.</p>

      <label for="tbillType">Which T-Bill are you bidding for?</label>
      <select id="tbillType">
        <option value="28">28 Days</option>
        <option value="91">91 Days</option>
        <option value="182">182 Days</option>
        <option value="364">364 Days</option>
      </select>

      <label for="quantity">How many T-Bills are you buying?</label>
      <input type="number" id="quantity" placeholder="e.g. 10">

      <label for="yield">Your bid yield (% per year):</label>
      <input type="number" id="yield" placeholder="e.g. 12.5" step="0.01">

      <label for="bidDate">Auction Date:</label>
      <input type="date" id="bidDate">

      <button class="btn" onclick="calculateAuction()">Calculate</button>

      <div id="result"></div>

      <!-- Chart + Table -->
      <div class="chart-box">
        <canvas id="tBillChart"></canvas>
      </div>
<div></div>
<div></div>      
<div id="daily-table-container"></div>
    </div>
  </div>

  <script>
    let chartInstance = null;

    function calculateAuction() {
      const days = parseInt(document.getElementById("tbillType").value);
      const qty = parseInt(document.getElementById("quantity").value);
      const yieldRate = parseFloat(document.getElementById("yield").value);
      const bidDateValue = document.getElementById("bidDate").value;

      if (!days || !qty || !yieldRate || !bidDateValue) {
        alert("Please fill in all fields correctly.");
        return;
      }

      const bidDate = new Date(bidDateValue);
      const maturityDate = new Date(bidDate);
      maturityDate.setDate(bidDate.getDate() + days);

      const faceValuePerTBill = 5000;
      const totalFaceValue = qty * faceValuePerTBill;
      const pricePerTBill = faceValuePerTBill / (1 + (yieldRate / 100) * (days / 365));
      const totalPayment = pricePerTBill * qty;
      const discount = totalFaceValue - totalPayment;

      // Fee (0.1%)
      const feeRate = 0.10;
      const totalFeeAmount = (totalPayment * feeRate) / 100;
      const totalToSend = totalPayment + totalFeeAmount;
      const netProfit = totalFaceValue - totalToSend;

      // --- Result Summary ---
      const resultHTML = `
        <h3>Calculation Summary</h3>
        <table class="result-table">
          <tr><th>Description</th><th>Amount / Value</th><th>Notes</th></tr>
          <tr><td>T-Bill Type</td><td>${days} days</td><td>Selected maturity</td></tr>
          <tr><td>Quantity</td><td>${qty}</td><td>Each = 5,000 ETB face value</td></tr>
          <tr><td>Bid Yield</td><td>${yieldRate.toFixed(2)}%</td><td>Annualized</td></tr>
            <tr><td>Total Discounted price per bill </td><td>${pricePerTBill.toFixed(2)} ETB</td><td>Before fees</td></tr>

          <tr><td>Total Discounted price</td><td>${totalPayment.toFixed(2)} ETB</td><td>Before fees</td></tr>
          <tr><td>Total Face Value</td><td>${totalFaceValue.toFixed(2)} ETB</td><td>At maturity</td></tr>
          <tr><td>Gross Profit</td><td>${discount.toFixed(2)} ETB</td><td>Before fees</td></tr>
          <tr><td>Maturity Date</td><td>${maturityDate.toDateString()}</td><td>Expected redemption</td></tr>
          <tr><td>CBE Capital Fee (0.1%)</td><td>${totalFeeAmount.toFixed(2)} ETB</td><td>Commission</td></tr>
          <tr><td><strong>Total to Send</strong></td><td><strong>${totalToSend.toFixed(2)} ETB</strong></td><td>Including fees</td></tr>
          <tr><td><strong>Net Profit</strong></td><td><strong>${netProfit.toFixed(2)} ETB</strong></td><td>After fees</td></tr>
        </table>
      `;
      document.getElementById("result").innerHTML = resultHTML;
      document.getElementById("result").style.display = "block";

      // --- Chart + Table Data ---
      const labels = [];
      const values = [];
      const yields = [];
      const tableRows = [];
      const priceStart = pricePerTBill;
      const priceEnd = faceValuePerTBill;

      for (let d = 0; d <= days; d++) {
        const date = new Date(bidDate);
        date.setDate(bidDate.getDate() + d);
        const dateStr = date.toISOString().slice(0,10);

        const valuePerBill = priceStart + (priceEnd - priceStart) * (d / days);
        const totalVal = valuePerBill * qty;

        // --- Realistic yield formula ---
        const remainingDays = days - d;
        let yieldRem = 0;
        if (remainingDays > 0) {
          yieldRem = ((faceValuePerTBill - valuePerBill) / valuePerBill) * (365 / remainingDays) * 100;
        } else {
          yieldRem = yields[yields.length - 1] || 0;
        }

        labels.push(dateStr);
        values.push(totalVal);
        yields.push(yieldRem);

        tableRows.push(`<tr>
          <td>${d}</td>
          <td>${dateStr}</td>
          <td>${totalVal.toFixed(2)}</td>
          <td>${yieldRem.toFixed(2)}%</td>
        </tr>`);
      }

      // --- Chart ---
      const ctx = document.getElementById("tBillChart").getContext("2d");
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Total Value (ETB)",
              data: values,
              borderColor: "#004aad",
              backgroundColor: "rgba(0,74,173,0.2)",
              tension: 0.3,
              fill: true,
              yAxisID: "y",
            },
            {
              label: "Yield Remaining (%)",
              data: yields,
              borderColor: "#f39c12",
              tension: 0.3,
              yAxisID: "y1",
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: {
                display: true,
                text: "Days to Maturity",
                color: "#fff",
                font: { weight: "bold", size: 14 }
              },
              ticks: {
                color: "#fff",
                font: { weight: "bold", size: 12 }
              },
              grid: { color: "rgba(255,255,255,0.15)" }
            },
            y: {
              title: { 
                display: true, 
                text: "Value (ETB)",
                color: "#fff",
                font: { weight: "bold", size: 14 }
              },
              ticks: {
                color: "#fff",
                font: { weight: "bold", size: 12 }
              },
              beginAtZero: false,
              grid: { color: "rgba(255,255,255,0.15)" }
            },
            y1: {
              position: "right",
              title: { 
                display: true, 
                text: "Yield (%)",
                color: "#fff",
                font: { weight: "bold", size: 14 }
              },
              ticks: {
                color: "#fff",
                font: { weight: "bold", size: 12 }
              },
              beginAtZero: true,
              grid: { drawOnChartArea: false }
            }
          },
          plugins: {
            legend: {
              position: "top",
              labels: { 
                color: "#fff",
                font: { weight: "bold", size: 13 }
              }
            },
            tooltip: {
              titleFont: { weight: "bold", size: 13 },
              bodyFont: { size: 12 }
            }
          }
        }
      });

      // --- Daily Breakdown Table ---
      document.getElementById("daily-table-container").innerHTML = `
        <h3>ðŸ“Š Daily Breakdown</h3>
        <table class="result-table">
          <tr>
            <th>Day</th>
            <th>Date</th>
            <th>Total Value (ETB)</th>
            <th>Yield Remaining (%)</th>
          </tr>
          ${tableRows.join("")}
        </table>
      `;
      document.getElementById("result").style.display = "block";
      document.getElementById("daily-table-container").style.display = "block";
    }
  </script>
</body>
</html>
